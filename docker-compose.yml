services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: devops
      POSTGRES_PASSWORD: devops
      POSTGRES_DB: devops
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devops -d devops"]
      interval: 5s
      timeout: 5s
      retries: 20

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL:-postgresql+psycopg://devops:devops@postgres:5432/devops}
      AGENT_TOKEN_PEPPER: ${AGENT_TOKEN_PEPPER:-super_secret_pepper_change_me}
      OFFLINE_AFTER_SECONDS: ${OFFLINE_AFTER_SECONDS:-120}
      ALERT_DEDUPE_SECONDS: ${ALERT_DEDUPE_SECONDS:-600}
      APP_PUBLIC_INSTALL_SH_URL: ${APP_PUBLIC_INSTALL_SH_URL:-http://localhost:8000/install.sh}
      API_BASE_URL: ${API_BASE_URL:-http://localhost:8000}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASS: ${SMTP_PASS:-}
      SMTP_FROM: ${SMTP_FROM:-}
      SMTP_TLS: ${SMTP_TLS:-true}
      SEND_RECOVERY_EMAILS: ${SEND_RECOVERY_EMAILS:-false}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
      SUPABASE_AUTH_TIMEOUT_SEC: ${SUPABASE_AUTH_TIMEOUT_SEC:-10}
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      LLM_MODEL: ${LLM_MODEL:-gpt-4.1-mini}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      LLM_TIMEOUT_SEC: ${LLM_TIMEOUT_SEC:-45}
      LLM_SUGGEST_ONLY: ${LLM_SUGGEST_ONLY:-true}
      LLM_MAX_CONTEXT_CHARS: ${LLM_MAX_CONTEXT_CHARS:-12000}
      ADMIN_NOTIFY_EMAILS: ${ADMIN_NOTIFY_EMAILS:-sautma223@gmail.com}
      AGENT_DEFAULT_IMAGE: ${AGENT_DEFAULT_IMAGE:-bsign/devops-agent:latest}
    ports:
      - "8000:8000"
    restart: unless-stopped

volumes:
  postgres_data:
